`CLUSTER SETSLOT`负责以不同的方式更改接收节点中哈希槽的状态。根据所使用的子命令，它可以：

1.  `MIGRATING`子命令：在 中设置哈希槽*迁移*州。
2.  `IMPORTING`子命令：在 中设置哈希槽*进口*州。
3.  `STABLE`子命令：从哈希槽中清除任何导入/迁移状态。
4.  `NODE`子命令：将哈希槽绑定到其他节点。

该命令及其子命令集对于启动和结束群集实时重新分片操作非常有用，这些操作通过在源节点中设置迁移状态的哈希槽以及在目标节点中导入状态来完成。

下面记录了每个子命令。最后，您将找到
如何使用此命令和其他相关命令执行实时重新分片。

## 集群集频`<slot>`迁移`<destination-node-id>`

此子命令将槽设置为*迁移*州。为了设置一个插槽
在此状态下，接收命令的节点必须是哈希槽所有者，
否则将返回错误。

当插槽设置为迁移状态时，节点会更改
以下方式：

1.  如果收到有关现有键的命令，则该命令将照常处理。
2.  如果收到有关不存在的键的命令，则`ASK`重定向由节点发出，要求客户端仅重试该特定查询`destination-node`.在这种情况下，客户端不应将其哈希槽更新到节点映射。
3.  如果命令包含多个键，如果不存在，则行为与第 2 点相同，如果所有键都存在，则与第 1 点相同，但是如果只存在部分数量的键，则该命令发出`TRYAGAIN`错误，以便感兴趣的键完成迁移到目标节点，以便可以执行多键命令。

## 集群集频`<slot>`进口`<source-node-id>`

此子命令的反面是`MIGRATING`，并准备目标
节点以从指定的源节点导入密钥。该命令仅在以下情况下有效：
该节点尚未具有指定哈希槽的所有者。

当插槽设置为导入状态时，节点将按以下方式更改行为：

1.  有关此哈希槽的命令被拒绝，并且`MOVED`重定向是像往常一样生成的，但在这样的情况下，命令遵循`ASKING`命令，在这种情况下，将执行命令。

这样，当处于迁移状态的节点生成`ASK`重定向，客户端联系目标节点，发送`ASKING`，并在发送命令后立即发送。这样，有关旧节点中不存在的键或已迁移到目标节点的键的命令将在目标节点中执行，以便：

1.  始终在目标节点中创建新键。在哈希槽迁移期间，我们只需要移动旧密钥，而不能移动新密钥。
2.  有关已迁移密钥的命令在作为迁移目标的节点（新的哈希槽所有者）的上下文中正确处理，以确保一致性。
3.  没有`ASKING`行为与平时相同。这可以保证哈希槽映射中断的客户端不会写入目标节点中的错误，从而创建尚未迁移的密钥的新版本。

## 集群集频`<slot>`稳定

此子命令仅从插槽中清除迁移/导入状态。是的
主要用于通过以下方式修复卡在错误状态的集群`redis-cli --cluster fix`.
通常，这两个状态在迁移结束时会自动清除
使用`SETSLOT ... NODE ...`子命令，如下一节所述。

## 集群集频`<slot>`节点`<node-id>`

这`NODE`子命令是具有最复杂语义的命令。它
将哈希槽与指定节点相关联，但该命令有效
仅在特定情况下，并且具有不同的副作用，具体取决于
插槽状态。以下是一组前提条件和副作用
命令：

1.  如果当前哈希槽所有者是接收命令的节点，但为了执行命令，该槽将分配给其他节点，则如果接收该命令的节点中仍有该哈希槽的键，则该命令将返回错误。
2.  如果插槽位于*迁移*状态，当插槽分配给另一个节点时，状态将被清除。
3.  如果插槽位于*进口*状态在接收命令的节点中，并且该命令将插槽分配给此节点（在将哈希插槽从一个节点重新分片到另一个节点结束时，在目标节点中发生这种情况），该命令具有以下副作用：A）*进口*状态已清除。B） 如果节点配置纪元还不是集群中最大的一个，它会生成一个新的纪元，并将新的配置纪元分配给自己。这样，其新的哈希槽所有权将胜过以前故障转移或槽迁移创建的任何过去的配置。

请务必注意，步骤 3 是 Redis 集群节点在未经其他节点同意的情况下创建新的配置纪元的唯一时间。仅当操作手动配置时，才会发生这种情况。但是，这不可能创建两个节点具有相同配置纪元的非瞬态设置，因为 Redis Cluster 使用配置纪元冲突解决算法。

@return

@simple字符串回复：所有子命令返回`OK`如果命令成功。否则，将返回错误。

## Redis 集群实时重新分片说明

这`CLUSTER SETSLOT`命令是 Redis 集群用来将一个哈希槽中包含的所有密钥从一个节点迁移到另一个节点的重要部分。这是在其他命令的帮助下协调迁移的方式。我们将具有哈希槽当前所有权的节点称为`source`节点，以及我们要迁移的节点`destination`节点。

1.  将目标节点插槽设置为*进口*状态使用`CLUSTER SETSLOT <slot> IMPORTING <source-node-id>`.
2.  将源节点插槽设置为*迁移*状态使用`CLUSTER SETSLOT <slot> MIGRATING <destination-node-id>`.
3.  从源节点获取密钥`CLUSTER GETKEYSINSLOT`命令，然后使用`MIGRATE`命令。
4.  发送`CLUSTER SETSLOT <slot> NODE <destination-node-id>`到目标节点。
5.  发送`CLUSTER SETSLOT <slot> NODE <destination-node-id>`添加到源节点。
6.  发送`CLUSTER SETSLOT <slot> NODE <destination-node-id>`添加到其他主节点（可选）。

笔记：

*   步骤 1 和 2 的顺序很重要。我们希望目标节点准备好接受`ASK`将源节点配置为重定向时的重定向。
*   步骤 4 和 5 的顺序很重要。
    目标节点负责将更改传播到群集的其余部分。
    如果在目标节点之前通知源节点，并且目标节点在设置为新的插槽所有者之前崩溃，则即使在成功的故障转移之后，该插槽也不会有所有者。
*   步骤 6，发送`SETSLOT`到不参与重新分片的节点在技术上不是必需的，因为配置最终会传播自己。
    但是，这样做是个好主意，以便阻止节点指向尽快移动的哈希槽的错误节点，从而减少重定向以找到正确的节点。
