***

## 标题： “Redis 信号处理”&#xA;链接标题： “信号处理”&#xA;体重： 1&#xA;描述： Redis 如何处理常见的 Unix 信号&#xA;别名：&#xA;\- /主题/信号

本文档提供有关 Redis 如何对不同的 POSIX 信号做出反应的信息，例如`SIGTERM`和`SIGSEGV`.

本文档中的信息**仅适用于 Redis 版本 2.6 或更高版本**.

## SIGTERM 和 SIGINT

这`SIGTERM`和`SIGINT`信号告诉 Redis 正常关闭。当服务器收到此信号时，
它不会立即退出。相反，它计划
类似于`SHUTDOWN`命令。计划的关机会尽快开始，特别是只要
当前正在执行的命令终止（如果有），并可能附加
延迟 0.1 秒或更短。

如果服务器被长时间运行的 Lua 脚本阻止，
杀死脚本`SCRIPT KILL`如果可能的话。计划的关机将
在脚本被终止或自发终止后立即运行。

此关机过程包括以下操作：

*   如果复制中有任何副本滞后：
    *   暂停尝试写入的客户端`CLIENT PAUSE`和`WRITE`选择。
    *   等待到已配置的`shutdown-timeout`（默认为 10 秒），让副本赶上主服务器的复制偏移量。
*   如果后台子进程正在保存 RDB 文件或执行 AOF 重写，则子进程将被终止。
*   如果 AOF 处于活动状态，Redis 将调用`fsync`系统调用 AOF 文件描述符以刷新磁盘上的缓冲区。
*   如果将 Redis 配置为使用 RDB 文件保留在磁盘上，则执行同步（阻塞）保存。由于保存是同步的，因此它不会使用任何额外的内存。
*   如果服务器已守护，则删除 PID 文件。
*   如果启用了 Unix 域套接字，它将被删除。
*   服务器退出时退出，退出代码为零。

如果无法保存 RDB 文件，则关闭将失败，并且服务器将继续运行以确保不会丢失数据。
同样，如果用户刚刚打开 AOF，并且服务器触发了第一次 AOF 重写以创建初始 AOF 文件，但无法保存此文件，则关闭将失败，服务器将继续运行。
自 Redis 2.6.11 起，除非新的`SIGTERM`已接收或`SHUTDOWN`命令已发出。

从 Redis 7.0 开始，服务器等待滞后副本直到可配置`shutdown-timeout`，默认情况下为 10 秒，然后关闭。
这样可以尽最大努力在未配置保存点且停用 AOF 的情况下最大程度地降低数据丢失的风险。
在版本 7.0 之前，在无盘设置中关闭负载过重的主节点更有可能导致数据丢失。
要将此类设置中数据丢失的风险降至最低，请触发手动`FAILOVER`（或`CLUSTER FAILOVER`） 以将主节点降级为副本，并在关闭主节点之前将其中一个副本提升为新的主节点。

## SIGSEGV，SIGBUS，SIGFPE和SIGIL

以下信号作为 Redis 崩溃进行处理：

*   SIGSEGV
*   西格布斯
*   SIGFPE
*   西吉尔

捕获这些信号之一后，Redis 将停止任何当前操作并执行以下操作：

*   将错误报告添加到日志文件。这包括堆栈跟踪、寄存器转储以及有关客户端状态的信息。
*   从 Redis 2.8 开始，将执行快速内存测试，作为对崩溃系统可靠性的首次检查。
*   如果服务器已守护，则删除 PID 文件。
*   最后，服务器为接收的信号取消注册自己的信号处理程序，并将相同的信号重新发送到自身，以确保执行默认操作，例如在文件系统上转储内核。

## 子进程被终止时会发生什么

当执行仅追加文件重写的子项被信号杀死时，
Redis 将此作为错误处理，并丢弃（可能是部分或已损坏）
AOF 文件。稍后将再次尝试重写。

当执行 RDB 保存的子项被终止时，Redis 将处理
条件为更严重的错误。而失败的
AOF文件重写可能导致AOF文件放大，RDB文件失败
创建会降低持久性。

由于生成 RDB 文件的子文件被信号杀死，
或者当子项退出时出现错误（非零退出代码），Redis 进入
不接受进一步写入命令的特殊错误情况。

*   Redis 将继续回复读取命令。
*   Redis 将使用`MISCONFIG`错误。

此错误情况将一直存在，直到可以成功创建 RDB 文件。

## 终止 RDB 文件而不出现错误

有时，用户可能希望终止 RDB 保存子进程，而无需
生成错误。从 Redis 版本 2.6.10 开始，这可以使用信号来完成`SIGUSR1`.此信号以特殊方式处理：
它像任何其他信号一样杀死子进程，但父进程将
未将此检测为严重错误，并将继续提供写入服务
请求。
