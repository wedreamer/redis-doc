***

## 标题： “Redis 延迟监控”&#xA;链接标题：“延迟监控”&#xA;体重： 1&#xA;描述： 在 Redis 中发现服务器运行缓慢的事件&#xA;别名：&#xA;\- /主题/延迟监视器

Redis通常用于要求苛刻的用例，其中
每个实例每秒处理大量查询，但对平均响应也有严格的延迟要求
时间和最坏情况的延迟。

虽然 Redis 是一个内存中系统，但它处理
不同的方式，例如，在保存到磁盘的上下文中。
此外，Redis实现了一组丰富的命令。某些命令
速度快，以恒定或对数时间运行。其他命令速度较慢
可能导致延迟峰值的 O（N） 命令。

最后，Redis是单线程的。这通常是一个优势
从每个内核可以执行的工作量的角度来看，并且
它能够提供的延迟数字。但是，它摆姿势
延迟的挑战，因为单
线程必须能够以增量方式执行某些任务，对于
示例密钥过期，以不影响其他客户端的方式
被服务。

由于所有这些原因，Redis 2.8.13 引入了一个名为
**延迟监控**，可帮助用户检查和排除可能的故障
延迟问题。延迟监控由以下概念组成
部件：

*   对不同的延迟敏感代码路径进行采样的延迟挂钩。
*   延迟峰值的时间序列记录，按不同事件拆分。
*   用于从时间序列中获取原始数据的报告引擎。
*   分析引擎，根据测量结果提供人类可读的报告和提示。

本文档的其余部分将介绍延迟监控子系统
详。有关 Redis 的一般主题的更多信息
和延迟，请参阅[Redis 延迟问题故障排除](/topics/latency).

## 事件和时间序列

不同的受监视代码路径具有不同的名称，称为*事件*.
例如`command`是测量可能很慢的延迟峰值的事件
命令执行，而`fast-command`是监视的事件名称
的 O（1） 和 O（log N） 命令。其他事件不太通用，并且监视
Redis 执行的特定操作。例如，`fork`事件
仅监视 Redis 执行`fork(2)`系统调用。

延迟峰值是运行时间比配置的延迟更多的事件
门槛。每个受监视者都有一个单独的时间序列
事件。这是时间序列的工作原理：

*   每次发生延迟峰值时，都会将其记录在相应的时间序列中。
*   每个时间序列由 160 个元素组成。
*   每个元素都是一对由 Unix 时间戳组成的，该时间戳包含测量延迟峰值的时间以及事件执行所花费的毫秒数。
*   同一秒内发生的同一事件的延迟峰值通过采用最大延迟进行合并。即使针对给定事件测量了连续延迟峰值（这可能在阈值较低的情况下发生），也至少可以使用 160 秒的历史记录。
*   记录每个元素的所有时间最大延迟。

框架监视并记录这些事件的执行时间内的延迟峰值：

*   `command`：常规命令。
*   `fast-command`：O（1） 和 O（log N） 命令。
*   `fork`：该`fork(2)`系统调用。
*   `rdb-unlink-temp-file`：该`unlink(2)`系统调用。
*   `aof-write`：写入 AOF - 一个包罗万象的事件`fsync(2)`系统调用。
*   `aof-fsync-always`：该`fsync(2)`由 调用的系统调用`appendfsync allways`政策。
*   `aof-write-pending-fsync`：该`fsync(2)`存在挂起的写入时的系统调用。
*   `aof-write-active-child`：该`fsync(2)`由子进程执行时的系统调用。
*   `aof-write-alone`：该`fsync(2)`由主进程执行时的系统调用。
*   `aof-fstat`：该`fstat(2)`系统调用。
*   `aof-rename`：该`rename(2)`系统调用，用于在完成后重命名临时文件`BGREWRITEAOF`.
*   `aof-rewrite-diff-write`：写入执行时累积的差异`BGREWRITEAOF`.
*   `active-defrag-cycle`：活动的碎片整理周期。
*   `expire-cycle`：过期周期。
*   `eviction-cycle`：逐出周期。
*   `eviction-del`：在逐出周期内删除。

## 如何启用延迟监控

对于一个用例而言，高延迟可能不被视为另一个用例的高延迟。某些应用程序可能要求在 1 毫秒内处理所有查询。对于其他应用程序，少量客户端偶尔遇到 2 秒的延迟可能是可以接受的。

启用延迟监视器的第一步是设置**延迟阈值**以毫秒为单位。只有花费的时间超过指定阈值的事件才会记录为延迟峰值。用户应根据自己的需要设置阈值。例如，如果应用程序要求最大可接受延迟为 100 毫秒，则应将阈值设置为在等于或大于 100 毫秒的时间内记录阻止服务器的所有事件。

在生产服务器中运行时启用延迟监视器
使用以下命令：

    CONFIG SET latency-monitor-threshold 100

默认情况下，监视处于关闭状态（阈值设置为 0），即使延迟监视的实际成本接近于零也是如此。虽然延迟监控的内存要求非常小，但没有充分的理由提高运行良好的 Redis 实例的基准内存使用率。

## 使用“延迟”命令报告信息

延迟监控子系统的用户界面是`LATENCY`命令。
像许多其他 Redis 命令一样，`LATENCY`接受修改其行为的子命令。这些子命令是：

*   `LATENCY LATEST`- 返回所有事件的最新延迟示例。
*   `LATENCY HISTORY`- 返回给定事件的延迟时间序列。
*   `LATENCY RESET`- 重置一个或多个事件的延迟时间序列数据。
*   `LATENCY GRAPH`- 呈现事件延迟样本的 ASCII 艺术图。
*   `LATENCY DOCTOR`- 使用人类可读的延迟分析报告进行回复。

有关详细信息，请参阅每个子命令的文档页。
