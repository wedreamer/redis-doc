***

标题： “哨兵客户端规范”
链接标题： “哨兵客户端”
体重： 2
描述： 如何为 Redis Sentinel 构建客户端
别名：

*   /topics/sentinel-client

***

Redis Sentinel 是 Redis 实例的监控解决方案，可处理
Redis 主节点的自动故障转移和服务发现（谁是当前
给定实例组的主实例？因为哨兵既负责
用于在故障转移期间重新配置实例，并提供配置
连接到 Redis 主服务器或副本的客户端，客户端必须具有
显式支持 Redis Sentinel。

本文档面向希望在其客户端实现中支持 Sentinel 的 Redis 客户端开发人员，其目标如下：

*   通过圣天诺自动配置客户端。
*   提高了 Redis Sentinel 自动故障转移的安全性。

有关 Redis Sentinel 如何工作的详细信息，请查看[Redis 文档](/topics/sentinel)，因为本文档仅包含 Redis 客户端开发人员所需的信息，并且希望读者熟悉 Redis Sentinel 的工作方式。

## 通过 Sentinel 发现 Redis 服务

Redis Sentinel 使用“stats”或“cache”等名称标识每个主节点。
每个名称实际上都标识*实例组*，由一个主控组成
和可变数量的副本。

在发生自动故障转移、手动触发的故障转移（例如，为了升级 Redis 实例）等事件后，用于网络内特定目的的 Redis 主服务器的地址可能会更改。

通常，Redis 客户端具有某种硬编码配置，该配置将网络中 Redis 主实例的地址指定为 IP 地址和端口号。但是，如果主地址发生更改，则需要在每个客户端中进行手动干预。

支持 Sentinel 的 Redis 客户端可以使用 Redis Sentinel 从主名称中自动发现 Redis 主节点的地址。因此，支持 Sentinel 的客户端应该能够选择性地接受以下输入，而不是硬编码的 IP 地址和端口：

*   指向已知 Sentinel 实例的 ip：端口对的列表。
*   服务的名称，如“缓存”或“时间线”。

这是客户端应遵循的过程，以便从哨兵列表和服务名称开始获取主地址。

## 步骤 1：连接到第一个哨兵

客户端应循环访问哨兵地址列表。对于每个地址，它应该尝试使用短超时（以几百毫秒的顺序）连接到Sentinel。如果出现错误或超时，应尝试下一个 Sentinel 地址。

如果尝试了所有 Sentinel 地址都未成功，则应向客户端返回错误。

第一个回复客户端请求的 Sentinel 应放在列表的开头，以便在下次重新连接时，我们将首先尝试在上一次连接尝试中可访问的 Sentinel，从而最大程度地减少延迟。

## 第2步：询问主地址

建立与 Sentinel 的连接后，客户端应重试在 Sentinel 上执行以下命令：

    SENTINEL get-master-addr-by-name master-name

哪里*主名称*应替换为用户指定的实际服务名称。

此调用的结果可以是以下两个答复之一：

*   ip：端口对。
*   空回复。这意味着哨兵不认识这个大师。

如果收到 ip：端口对，则应使用此地址连接到 Redis 主服务器。否则，如果收到空回复，客户端应尝试列表中的下一个 Sentinel。

## 步骤 3：在目标实例中调用 ROLE 命令

客户端发现主实例的地址后，应
尝试与主服务器连接，并调用`ROLE`命令按顺序排列
以验证实例的角色是否为主节点。

如果`ROLE`命令不可用（它是在 Redis 2.8.12 中引入的），客户端可能会求助于`INFO replication`命令解析`role:`字段。

如果实例不是预期的主实例，则客户端应等待一小段时间 （几百毫秒），并应从步骤 1 开始重试。

# 处理重新连接

将服务名称解析为主地址并与 Redis 主实例建立连接后，每次需要重新连接时，客户端都应使用从步骤 1 重新启动的 Sentinels 再次解析该地址。例如，Sentinel应再次联系以下情况：

*   如果客户端在超时或套接字错误后重新连接。
*   如果客户端因为用户显式关闭或重新连接而重新连接而重新连接。

在上述情况以及客户端丢失与 Redis 服务器连接的任何其他情况下，客户端应再次解析主地址。

# 哨兵故障转移断开连接

从 Redis 2.8.12 开始，当 Redis Sentinel 更改
实例，例如，将副本提升为主副本，将主副本降级为
在故障转移后复制到新的主服务器，或者干脆更改主服务器
一个过时的副本实例的地址，它发送一个`CLIENT KILL type normal`
命令到实例，以确保所有客户端都已断开连接
从重新配置的实例。这将强制客户端解析主服务器
再次地址。

如果客户端将联系尚未更新信息的 Sentinel，则通过`ROLE`命令将失败，允许客户端检测到所联系的 Sentinel 提供了过时的信息，然后重试。

注意：在客户端联系过时的 Sentinel 实例的同时，陈旧的主服务器可能会联机返回，因此客户端可能会与陈旧的主服务器连接，但 ROLE 输出将匹配。但是，当主服务器再次返回时，Sentinel 将尝试将其降级为副本，从而触发新的断开连接。同样的原因也适用于连接到陈旧的副本，这些副本将被重新配置为使用不同的主节点进行复制。

# 连接到副本

有时，客户端有兴趣连接到副本，例如，为了扩展读取请求。此协议支持通过稍微修改步骤 2 来连接到副本。而不是调用以下命令：

    SENTINEL get-master-addr-by-name master-name

客户端应改为调用：

    SENTINEL replicas master-name

为了检索副本实例的列表。

对称地，客户端应使用`ROLE`命令
实例实际上是一个副本，以避免缩放读取查询
主人。

# 连接池

对于实现连接池的客户端，在重新连接单个连接时，应再次联系 Sentinel，如果主地址发生更改，则应关闭所有现有连接并将其连接到新地址。

# 错误报告

如果出现错误，客户端应正确地将信息返回给用户。具体说来：

*   如果没有可以联系到哨兵（因此客户永远无法获得回复`SENTINEL get-master-addr-by-name`），应返回一个明确指出 Redis Sentinel 无法访问的错误。
*   如果池中的所有 Sentinels 都以空回复进行回复，则应通知用户一个错误，指出 Sentinels 不知道此主节点名称。

# 哨兵列表自动刷新

（可选）一旦成功回复`get-master-addr-by-name`收到后，客户端可以按照以下过程更新其内部哨兵节点列表：

*   使用命令获取此主服务器的其他哨兵列表`SENTINEL sentinels <master-name>`.
*   在列表末尾添加列表中尚不存在的每个 ip：port 对。

客户端不需要能够使列表持久更新其自己的配置。升级哨兵列表的内存中表示的能力对于提高可靠性已经很有用。

# 订阅哨兵事件以提高响应能力

这[哨兵文档](/topics/sentinel)显示客户端如何连接到
使用 Pub/Sub 的 Sentinel 实例，以便订阅
Redis 实例配置。

此机制可用于加快客户端的重新配置，
也就是说，客户端可以收听 Pub/Sub，以便了解何时配置
更改发生了，以便运行此处解释的三步协议
文档，以便解析新的 Redis 主（或副本）地址。

但是，通过 Pub/Sub 收到的更新消息不应替换
上述程序，因为不能保证客户能够
接收所有更新消息。

# 附加信息

有关其他信息或讨论本指南的特定方面，请向[Redis Google Group](https://groups.google.com/group/redis-db).
